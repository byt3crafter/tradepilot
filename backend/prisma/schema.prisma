generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String    @id // Clerk User ID
  email              String    @unique
  fullName           String
  isEmailVerified    Boolean   @default(false)
  role               String    @default("USER") // USER or ADMIN
  createdAt          DateTime  @default(now())
  lastLoginAt        DateTime?

  // Subscription / Billing
  subscriptionStatus String    @default("INACTIVE")
  trialEndsAt        DateTime?
  paddleCustomerId   String?   @unique
  paddleSubscriptionId String?
  proAccessExpiresAt DateTime?
  proAccessReason    String?
  planInterval       String?   // 'month' or 'year'
  subscriptionPrice  Float?     // Actual recurring price (e.g. 5.99 or 60.00)
  subscriptionCurrency String?  // e.g. "USD"
  
  // Referral System
  isEarlySupporter   Boolean   @default(false)
  referredByUserId   String?
  hasRewardedReferrer Boolean   @default(false)
  isLifetimeAccess    Boolean   @default(false)
  referrer           User?     @relation("Referrals", fields: [referredByUserId], references: [id])
  referrals          User[]    @relation("Referrals")

  // Relations
  brokerAccounts     BrokerAccount[]
  checklistRules     ChecklistRule[]
  trades             Trade[]
  playbooks          Playbook[]
  assetSpecs         AssetSpecification[]

  notifications      Notification[]
  apiUsage           ApiUsage[]
  usedInviteCodes    InviteCode[]
}

model BrokerAccount {
  id             String            @id @default(uuid())
  name           String
  type           BrokerAccountType
  initialBalance Float
  currentBalance Float
  currency       String            @default("USD")
  leverage       Int?
  feeModel       FeeModel          @default(SPREAD_ONLY)
  consistencyRule Float?           // e.g., 30 (for 30%)
  consistencyScore Float?          // Calculated score
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  userId         String
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  templateId     String?
  template       PropFirmTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  objectives     TradingObjective?
  smartLimits    SmartLimit?
  trades         Trade[]
  status         AccountStatus     @default(ACTIVE)
}

enum AccountStatus {
  ACTIVE
  FAILED
  PASSED
}

enum BrokerAccountType {
  DEMO
  LIVE
  PROP_FIRM
}

enum FeeModel {
  SPREAD_ONLY
  COMMISSION_ONLY
  COMMISSION_AND_SWAP
}

model TradingObjective {
  id              String        @id @default(uuid())
  isEnabled       Boolean       @default(false)
  profitTarget    Float?
  minTradingDays  Int?
  maxLoss         Float?
  maxDailyLoss    Float?

  brokerAccountId String        @unique
  brokerAccount   BrokerAccount @relation(fields: [brokerAccountId], references: [id], onDelete: Cascade)
}

model PropFirmTemplate {
  id                String          @id @default(uuid())
  name              String          // e.g., "FTMO $100k Challenge"
  firmName          String          // e.g., "FTMO"
  accountSize       Float           // e.g., 100000
  profitTarget      Float           // e.g., 10000
  dailyDrawdown     Float           // e.g., 5000
  maxDrawdown       Float           // e.g., 10000
  drawdownType      DrawdownType    @default(TRAILING)
  consistencyRule   Float?          // e.g., 30 (for 30%)
  minTradingDays    Int             // e.g., 10
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  brokerAccounts    BrokerAccount[]
}

enum DrawdownType {
  TRAILING
  STATIC
}

model SmartLimit {
  id              String             @id @default(uuid())
  isEnabled       Boolean            @default(false)
  severity        SmartLimitSeverity @default(HARD)
  maxRiskPerTrade Float?
  maxTradesPerDay Int?
  maxLossesPerDay Int?

  brokerAccountId String        @unique
  brokerAccount   BrokerAccount @relation(fields: [brokerAccountId], references: [id], onDelete: Cascade)
}

enum SmartLimitSeverity {
  SOFT
  HARD
}

model Playbook {
  id            String   @id @default(uuid())
  name          String
  coreIdea      String?
  isPublic      Boolean  @default(false)
  
  // Tags
  tradingStyles String[]
  instruments   String[]
  timeframes    String[]
  
  // Details
  pros          String[]
  cons          String[]
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  setups        PlaybookSetup[]
  trades        Trade[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model PlaybookSetup {
  id                  String   @id @default(uuid())
  name                String
  screenshotBeforeUrl String?
  screenshotAfterUrl  String?
  riskSettings        Json?    // Stores { riskPercent, stopLossType, maxPositionSize, etc. }
  
  playbookId          String
  playbook            Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)
  
  checklistItems      ChecklistItem[]
  trades              Trade[]
}

model ChecklistItem {
  id              String            @id @default(uuid())
  text            String
  type            ChecklistItemType
  
  playbookSetupId String
  playbookSetup   PlaybookSetup     @relation(fields: [playbookSetupId], references: [id], onDelete: Cascade)
}

enum ChecklistItemType {
  ENTRY_CRITERIA
  RISK_MANAGEMENT
  EXIT_RULES
  CONFIRMATION_FILTERS
}

model Trade {
  id                  String        @id @default(uuid())
  
  // Entry
  entryDate           DateTime
  asset               String
  direction           Direction
  entryPrice          Float
  lotSize             Float?
  isPendingOrder      Boolean       @default(false)
  
  // Exit
  exitDate            DateTime?
  exitPrice           Float?
  
  // Risk/Reward
  riskPercentage      Float
  stopLoss            Float?
  takeProfit          Float?
  rr                  Float?
  
  // Outcome
  profitLoss          Float?
  commission          Float?
  swap                Float?
  result              TradeResult?
  pips                Float?
  
  // Media
  screenshotBeforeUrl String?
  screenshotAfterUrl  String?
  
  // Relations
  userId              String
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  brokerAccountId     String
  brokerAccount       BrokerAccount @relation(fields: [brokerAccountId], references: [id], onDelete: Cascade)
  
  playbookId          String
  playbook            Playbook      @relation(fields: [playbookId], references: [id])

  playbookSetupId     String?
  playbookSetup       PlaybookSetup? @relation(fields: [playbookSetupId], references: [id])
  
  tradeJournal        TradeJournal?
  aiAnalysis          AiAnalysis?
  
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
}

enum Direction {
  Buy
  Sell
}

enum TradeResult {
  Win
  Loss
  Breakeven
}

model TradeJournal {
  id             String @id @default(uuid())
  mindsetBefore  String
  exitReasoning  String
  lessonsLearned String
  
  tradeId        String @unique
  trade          Trade  @relation(fields: [tradeId], references: [id], onDelete: Cascade)
}

model AiAnalysis {
  id         String @id @default(uuid())
  summary    String
  mistakes   Json
  goodPoints Json
  
  tradeId    String @unique
  trade      Trade  @relation(fields: [tradeId], references: [id], onDelete: Cascade)
}

model ChecklistRule {
  id        String   @id @default(uuid())
  rule      String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model AssetSpecification {
  id            String @id @default(uuid())
  symbol        String
  name          String
  pipSize       Float  @default(0.0001)
  lotSize       Float  @default(100000)
  valuePerPoint Float  @default(10)
  
  userId        String
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, symbol])
}



model Notification {
  id         String   @id @default(uuid())
  message    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  

}

model ApiUsage {
  id        String   @id @default(uuid())
  endpoint  String
  model     String
  tokens    Int
  cost      Float
  timestamp DateTime @default(now())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model InviteCode {
  id        String   @id @default(uuid())
  code      String   @unique
  type      InviteType
  duration  Int?     // Days for trial
  isUsed    Boolean  @default(false)
  expiresAt DateTime?
  createdAt DateTime @default(now())
  
  usedByUserId String?
  usedByUser   User?   @relation(fields: [usedByUserId], references: [id])
}

enum InviteType {
  TRIAL
  LIFETIME
}

model PromoCode {
  id        String   @id @default(uuid())
  code      String   @unique
  paddleDiscountId String?
  type      PromoType
  value     Float
  maxUses   Int?
  usedCount Int      @default(0)
  expiresAt DateTime?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PromoType {
  PERCENTAGE
  FIXED_AMOUNT
}

model PricingPlan {
  id              String   @id @default(uuid())
  paddlePriceId   String   @unique
  name            String
  description     String?
  interval        String   // 'month' or 'year'
  amount          Float
  currency        String   @default("USD")
  isActive        Boolean  @default(true)
  isBestValue     Boolean  @default(false)
  features        String[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}