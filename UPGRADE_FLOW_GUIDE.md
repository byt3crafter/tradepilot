# Trial to Payment Flow Guide

Complete walkthrough of how users see the trial countdown and upgrade to Pro.

## ğŸ“Š Trial Timeline

### Days 14-8: Normal Trial Period
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TrialBanner (Blue)                              â”‚
â”‚ "You have 10 days left in your trial."          â”‚
â”‚ [Upgrade Now] [Ã—]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Dashboard appears normally below banner
```

### Days 7-1: Warning Period
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TrialBanner (Blue) - Same message               â”‚
â”‚ "You have 3 days left in your trial."           â”‚
â”‚ [Upgrade Now] [Ã—]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Also in Settings â†’ Billing:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Current Status: Trial (Blue)                    â”‚
â”‚ Trial Ends: Jan 5, 2025                         â”‚
â”‚ 3 days remaining                                â”‚
â”‚                                                 â”‚
â”‚ âš ï¸ WARNING: Your trial is ending soon. Upgrade  â”‚
â”‚    now to maintain access to your account.      â”‚
â”‚                                                 â”‚
â”‚ [Upgrade to Pro] (button enabled)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Day 0: Trial Expired
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TrialBanner (Red/Risk-High)                     â”‚
â”‚ "Your free trial has ended. Please upgrade to   â”‚
â”‚  continue logging trades."                      â”‚
â”‚ [Upgrade Now] [Ã—]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Settings â†’ Billing shows:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Current Status: Trial (Blue)                    â”‚
â”‚ Trial Ends: Jan 2, 2025 (Past date)             â”‚
â”‚ 0 days remaining                                â”‚
â”‚                                                 â”‚
â”‚ "Trial expired - upgrade now to keep trading"  â”‚
â”‚                                                 â”‚
â”‚ [Upgrade to Pro] (button enabled, prominent)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’³ Upgrade Flow - Step by Step

### Step 1: User Sees Trial Banner
**Location**: Top of dashboard (on all pages)
**Trigger**: User is logged in AND subscriptionStatus = 'TRIALING'

```
User sees banner with countdown:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ You have 5 days left in your trial. [Upgrade Now]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Code**: `components/billing/TrialBanner.tsx`

### Step 2: User Clicks "Upgrade Now"
**Action**: navigateTo('settings', 'billing')

User is taken to Settings â†’ Billing tab

### Step 3: Settings â†’ Billing Shows Payment Options
**Location**: Dashboard â†’ Settings â†’ Billing

User sees:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subscription Status                              â”‚
â”‚                                                  â”‚
â”‚ Current Status: Trial (blue)                     â”‚
â”‚ Trial Ends: Jan 5, 2025                          â”‚
â”‚ 3 days remaining                                 â”‚
â”‚                                                  â”‚
â”‚ [Upgrade to Pro] â† MAIN BUTTON TO CLICK         â”‚
â”‚                                                  â”‚
â”‚ Billing FAQ                                      â”‚
â”‚ Q: What happens when my trial ends?             â”‚
â”‚ Q: Can I cancel anytime?                        â”‚
â”‚ Q: Do you offer refunds?                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Code**: `components/settings/BillingSettings.tsx`

### Step 4: Click "Upgrade to Pro" Button
**Action**: Creates Paddle checkout transaction

```
Button handler:
1. Creates transaction via POST /api/billing/checkout
2. Backend creates Paddle transaction for user
3. Returns transactionId
4. Opens Paddle.Checkout.open({ transactionId })
```

### Step 5: Paddle Checkout Opens
**Modal appears with payment form**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TradePilot Pro - Monthly                        â”‚
â”‚  $29.99/month                                    â”‚
â”‚                                                  â”‚
â”‚  Card Number: [4111 1111 1111 1111] â† For testing
â”‚  Expiry: [MM/YY]                                â”‚
â”‚  CVC: [123]                                     â”‚
â”‚                                                  â”‚
â”‚  [Pay Now]                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 6: Payment Processing
**Paddle processes card**

For sandbox testing:
- Card: `4111 1111 1111 1111`
- Any future expiry date (MM/YY)
- Any 3-digit CVC

### Step 7: Webhook Updates Subscription
**Backend receives Paddle webhook**

```
Paddle sends: subscription.created event
{
  "event_type": "subscription.created",
  "data": {
    "id": "sub_...",
    "customer_id": "ctm_...",
    "status": "active"
  }
}

Backend:
1. Finds user by paddleCustomerId
2. Updates user.subscriptionStatus = 'ACTIVE'
3. Sets user.paddleSubscriptionId
```

**Code**: `backend/src/billing/billing.service.ts` (line 152-163)

### Step 8: User Sees Confirmation
**On next load/refresh**

```
Settings â†’ Billing now shows:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subscription Status                              â”‚
â”‚                                                  â”‚
â”‚ Current Status: Active (green) âœ“                â”‚
â”‚ Pro Access Expires: Jan 5, 2026                 â”‚
â”‚                                                  â”‚
â”‚ âœ“ Your subscription is active. Thank you for    â”‚
â”‚   being a TradePilot user!                      â”‚
â”‚                                                  â”‚
â”‚ (No upgrade button shown)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TrialBanner disappears (isTrialing = false)
```

---

## ğŸ”§ Where to Test

### Test Trial Expiration Locally

**Expire trial immediately**:
```sql
UPDATE "User"
SET "trialEndsAt" = NOW() - INTERVAL '1 day'
WHERE email = 'test@example.com';
```

**Expire in 3 days** (test warning):
```sql
UPDATE "User"
SET "trialEndsAt" = NOW() + INTERVAL '3 days'
WHERE email = 'test@example.com';
```

**Reset to 14 days**:
```sql
UPDATE "User"
SET "trialEndsAt" = NOW() + INTERVAL '14 days'
WHERE email = 'test@example.com';
```

### Manual Testing Checklist

- [ ] Login and see trial banner at top
- [ ] Trial countdown shows correct days
- [ ] "Upgrade Now" button navigates to Settings â†’ Billing
- [ ] Settings â†’ Billing shows trial info
- [ ] "Upgrade to Pro" button opens Paddle checkout
- [ ] Complete checkout with test card (4111...)
- [ ] See payment success
- [ ] Refresh page - subscription status shows "Active"
- [ ] Trial banner disappears after upgrade
- [ ] Expire trial with SQL and verify red banner

---

## ğŸ”‘ Key Code Changes

### 1. Trial Days Calculation (AuthContext)
**File**: `context/AuthContext.tsx` (lines 89-101)

```typescript
// OLD (hardcoded):
const trialDaysRemaining = 14;
const isTrialExpired = false;

// NEW (calculated):
if (appUser?.trialEndsAt) {
  const now = new Date();
  const trialEnd = new Date(appUser.trialEndsAt);
  const diffMs = trialEnd.getTime() - now.getTime();
  const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

  trialDaysRemaining = Math.max(0, diffDays);
  isTrialExpired = diffDays <= 0;
}
```

### 2. Trial Banner Link (TrialBanner)
**File**: `components/billing/TrialBanner.tsx`

```typescript
// OLD:
onClick={requestUpgradeModal}  // Opened old subscription page

// NEW:
handleUpgrade = () => {
  navigateTo('settings', 'billing');  // Goes to Billing settings
}
```

### 3. Billing Payment Button (BillingSettings)
**File**: `components/settings/BillingSettings.tsx`

```typescript
const handleUpgrade = async () => {
  // 1. Create transaction on backend
  const { transactionId } = await api.post(
    '/api/billing/checkout',
    {},
    accessToken!
  );

  // 2. Open Paddle checkout
  paddle.Checkout.open({ transactionId });
}
```

---

## ğŸ“± Mobile View

Trial banner is responsive and works on all screen sizes:

**Mobile** (< 768px):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ You have 5 days left... â”‚
â”‚ [Upgrade Now] [Ã—]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tablet** (768px-1024px):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ You have 5 days left in trial. â”‚
â”‚ [Upgrade Now] [Ã—]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Production Setup

For production Paddle (not sandbox):

1. Update `.env`:
```env
PADDLE_ENV=production
PADDLE_API_KEY=live_... (from Paddle dashboard)
PADDLE_CLIENT_SIDE_TOKEN=live_...
PADDLE_PRICE_ID=pri_... (production price ID)
```

2. Update PaddleContext CDN:
```typescript
// Line 71 in context/PaddleContext.tsx
- s.src = "https://sandbox-cdn.paddle.com/paddle/v2/paddle.js";
+ s.src = "https://cdn.paddle.com/paddle/v2/paddle.js";

// Line 111
- p.Environment.set("sandbox");
+ p.Environment.set("production");
```

3. Test with real payment card and webhook

---

## ğŸ› Troubleshooting

### Issue: Paddle checkout not opening
**Solution**: Check browser console
```
1. "Paddle not initialized" â†’ Refresh page
2. No transactionId â†’ Check POST /api/billing/checkout response
3. Paddle undefined â†’ Check CDN loaded correctly
```

### Issue: Subscription not updating after payment
**Solution**: Check webhook logs
```
1. Verify webhook endpoint in Paddle dashboard
2. Check backend logs for webhook events
3. Ensure user's paddleCustomerId matches
```

### Issue: Trial countdown shows 14 forever
**Solution**: Check trialEndsAt in database
```sql
SELECT email, "trialEndsAt", "subscriptionStatus"
FROM "User"
WHERE email = 'test@example.com';
```

Ensure `trialEndsAt` is in past/future, not NULL

---

**Status**: âœ… Ready for Testing
**Tested**: âœ… Build passing
**Deployment**: Ready for sandbox testing â†’ production
